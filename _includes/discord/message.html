<script>
	customElements.define('discord-message', class extends HTMLElement
	{
		get isCompactMode()
		{
			return this.parentElement.hasAttribute('compact');
		}

		get isBotUser()
		{
			return this.hasAttribute('bot');
		}

		get author()
		{
			return this.getAttribute('author');
		}

		get avatar()
		{
			return this.getAttribute('avatar');
		}

		get roleColor()
		{
			if (!this.hasAttribute('role-color'))
				return;

			return this.getAttribute('role-color');
		}

		get highlight()
		{
			return this.hasAttribute('highlight');
		}

		connectedCallback()
		{
			this.classList.add('discord-message');

			if (this.isCompactMode)
				this.classList.add('discord-compact-mode');

			discordMessageTemplate.call(
				this,
				this.isCompactMode,
				this.author,
				this.avatar,
				this.isBotUser,
				this.roleColor,
				this.highlight
			);
		}
	});

	function discordMessageTemplate(compact, author, avatar, bot, roleColor, highlight)
	{
		console.log([compact, author, avatar, bot, roleColor, highlight]);

		const shadow = this.attachShadow({ mode: 'open' });
		shadow.innerHTML = `
		<style>
			:host(.discord-message) {
				display: flex;
				font-size: 0.9em;
				padding: 1em 0.5em;
				border-bottom: 1px solid rgba(255, 255, 255, 0.05);
			}
			:host-context(.discord-light-theme):host(.discord-message) {
				border-color: #eceeef;
			}
			:host(.discord-message:last-of-type) {
				border-bottom-width: 0;
			}
			:host(.discord-message) a {
				color: #0096cf;
				font-weight: normal;
				text-decoration: none;
			}
			:host(.discord-message) a:hover {
				text-decoration: underline;
			}
			:host(.discord-light-theme):host(.discord-message) a {
				color: #00b0f4;
			}
			:host(.discord-message) a:hover {
				text-decoration: underline;
			}
			:host(.discord-message) .discord-author-avatar {
				margin-top: 1px;
				margin-right: 16px;
				min-width: 40px;
			}
			:host(.discord-message) .discord-author-avatar img {
				width: 40px;
				height: 40px;
				border-radius: 50%;
			}
			:host(.discord-message) .discord-message-timestamp {
				color: #fff3;
				font-size: 12px;
				margin-left: 3px;
			}
			:host(.discord-message) .discord-message-edited {
				color: #fff3;
				font-size: 10px;
			}
			:host(.discord-message) .discord-message-content {
				width: 100%;
				line-height: 160%;
				font-weight: normal;
			}
			:host(.discord-message) .discord-message-body {
				position: relative;
			}
			:host-context(.discord-light-theme):host(.discord-message) .discord-message-timestamp,
			:host-context(.discord-compact-mode):host(.discord-message:hover) .discord-message-timestamp,
			:host-context(.discord-compact-mode):host-context(.discord-light-theme):host(.discord-message:hover) .discord-message-timestamp {
				color: #99aab5;
			}
			:host-context(.discord-compact-mode):host-context(.discord-light-theme):host(.discord-message) .discord-message-timestamp {
				color: #d1d9de;
			}
			:host-context(.discord-compact-mode):host(.discord-message) {
				padding-top: 0.5em;
				padding-bottom: 0.5em;
			}
			:host-context(.discord-compact-mode) .discord-author-avatar {
				display: none;
			}
			:host-context(.discord-compact-mode) .discord-message-body {
				margin-left: 0.25em;
			}
		</style>
		`
		
		const avatarDiv = document.createElement('div');
		shadow.appendChild(avatarDiv);
		{
			avatarDiv.classList.add('discord-author-avatar');

			const avatarImg = document.createElement('img', {});
			avatarImg.src = avatar;
			avatarImg.alt = author;

			avatarDiv.appendChild(avatarImg);
		}
		
		const contentDiv = document.createElement('div');
		shadow.appendChild(contentDiv);
		{
			contentDiv.classList.add('discord-message-content');

			if (!compact)
			{
				const authorInfoDiv = document.createElement('div');
				{
					console.log('creating author-info element');
					const authorInfo = document.createElement('AUTHOR-INFO');
					{
						authorInfo.setAttribute('author', author);

						if (bot)
							authorInfo.setAttribute('bot', bot);
	
						if (typeof roleColor !== 'undefined')
							authorInfo.setAttribute('role-color', roleColor);

						authorInfo.innerText = author;
					}
					authorInfoDiv.appendChild(authorInfo);

					const timestampSpan = document.createElement('span');
					{
						timestampSpan.classList.add('discord-message-timestamp');
						timestampSpan.innerHTML = new Date().toLocaleDateString('en-US', { day: '2-digit', month: '2-digit', year: 'numeric' });
					}
					authorInfoDiv.appendChild(timestampSpan);

				}
				contentDiv.appendChild(authorInfoDiv);
			}



			// TODO: add discord-message-body element which will contain highlight class, timestamp element, and author-info element
			//       Move slot into this element

			const slot = document.createElement('slot');
			contentDiv.appendChild(slot);
		}
	}
</script>
